---
title: "Introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(threesixtygiving)
```



## Retrieve all grants

```{r retrieve-grants, eval=FALSE, include=FALSE}
grants <- tsg_all_grants(timeout = 8, retries = 1)
```


## Core data

`tsg_all_grants` returns a list of tibbles, due to differences in the data provided by each funder. `tsg_core_data` returns a tibble with the 10 columns in the [360Giving Open Standard](https://standard.threesixtygiving.org/en/latest/#), plus the publisher prefix used to identify each funder. In the case below I have converted non-GBP currencies to GBP on the rates on 2019-10-24.

``` {r core-data, eval=FALSE}
library(purrr)
library(dplyr)

df <- tsg_core_data(grants)

df2 <- df %>% 
  mutate(amount_awarded = case_when(
    currency == "USD" ~ amount_awarded/1.29, ## rate on 2019-10-24
    currency == "CAD" ~ amount_awarded/1.69, 
    currency == "CHF" ~ amount_awarded/1.28, 
    currency == "EUR" ~ amount_awarded/1.16,
    TRUE ~ amount_awarded)) %>%
  group_by(funding_org_name) %>%
  summarise(n = n(),
            amount_awarded = sum(amount_awarded)) %>%
  mutate(avg = amount_awarded/n)
```


```{r value-of-all-grants, eval=FALSE}
library(ggplot2)

theme_set(theme_bw())

p1 <- ggplot(df2 %>% top_frac(0.2, amount_awarded),
             aes(x = reorder(funding_org_name, -amount_awarded),
                 y = amount_awarded, fill = amount_awarded)) + 
  geom_col() + 
  scale_y_sqrt(labels = scales::dollar_format(prefix = "£"),
               breaks = c(1e8, 1e9, 25e8, 4e9, 5e9, 75e8, 1e10)) + 
  scale_x_discrete(labels = scales::wrap_format(25)) + 
  scale_fill_viridis_c() + 
  labs(x = "Funder", y = "Amount Awarded",
       title = "Total Value of Grants Awarded",
       caption = "(c) Evan Odell | 2019 | CC-BY-SA
       Data from 360Giving") + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        legend.position = "none") 
  
p1
```


![](total-value.png)

The plot below shows the average grant value from each funder, with the number of reported grants given by each funder.

```{r avg-grant-size, eval=FALSE}

p2 <- ggplot(df2 %>% top_frac(0.2, avg),
             aes(x = reorder(funding_org_name, -avg),
                 y = avg, fill = avg)) + 
  geom_col() + 
   geom_label(aes(label = scales::comma(n), y = 10000),
              fill = "white", alpha = 0.5, size = 3.5) + 
  scale_y_sqrt(labels = scales::dollar_format(prefix = "£")) + 
  scale_x_discrete(labels = scales::wrap_format(25)) + 
  scale_fill_viridis_c() + 
  labs(x = "Funder", y = "Average Grant Value",
       title = "Average Grant Value",
       subtitle = "Label is the number of grants awarded",
       caption = "(c) Evan Odell | 2019 | CC-BY-SA
       Data from 360Giving") + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        legend.position = "none") 

p2
```

![](avg-grant-value.png)

```{r size, eval=FALSE}
library(ggrepel)

p3 <- ggplot(df2, aes(x = n, y = avg, colour = amount_awarded)) + 
  geom_point(alpha = 0.7, size = 4) + 
  geom_text_repel(data = bind_rows(df2 %>% top_n(5, avg),
                                   df2 %>% top_n(5, amount_awarded),
                                   df2 %>% top_n(5, n)) %>% 
                    distinct(),
                  mapping = aes(label =funding_org_name), colour = "black",
                  direction = "both",
                  nudge_x = 0.2) + 
  scale_colour_viridis_c() + 
  scale_y_log10(labels = scales::dollar_format(prefix = "£")) + 
  scale_x_log10(labels = scales::comma) + 
  labs(y = "Average Grant Value", x = "Number of Grants",
       title = "Average Grant Value vs Number of Grants",
       caption = "(c) Evan Odell | 2019 | CC-BY-SA
       Data from 360Giving") + 
  theme(legend.position = "none") 

p3
```

![](grant-size-n.png)

