---
title: "Introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(threesixtygiving)
```



## Retrieve all grants

```{r retrieve-grants, eval=FALSE}
grants <- tsg_all_grants(timeout = 8, retries = 1)
```

```{r save-grants eval=FALSE, include=FALSE}
library(readr)

write_rds(grants, "vignettes/grants.rds")

```



## Core data

`tsg_all_grants` returns a list of tibbles, due to differences in the data provided by each funder. `tsg_core_data` returns a tibble with the 10 columns in the [360Giving Open Standard](https://standard.threesixtygiving.org/en/latest/#), plus the publisher prefix used to identify each funder. In the case below I have converted non-GBP currencies to GBP on the rates on 2019-10-24.

```{r read-in-grant-rds eval=FALSE, include=FALSE}
library(readr)

grants <- read_rds("vignettes/grants.rds")
```


```{r core-data, eval=FALSE}
library(purrr)
library(dplyr)

df <- tsg_core_data(grants)
df3 <- tsg_process_data(grants)

df2 <- df %>% 
  mutate(amount_awarded = case_when(
    currency == "USD" ~ amount_awarded/1.29, ## rate on 2019-10-24
    currency == "CAD" ~ amount_awarded/1.69, 
    currency == "CHF" ~ amount_awarded/1.28, 
    currency == "EUR" ~ amount_awarded/1.16,
    TRUE ~ amount_awarded)) %>%
  group_by(funding_org_name) %>%
  summarise(n = n(),
            amount_awarded = sum(amount_awarded)) %>%
  mutate(avg = amount_awarded/n)
```


```{r value-of-all-grants, eval=FALSE}
library(ggplot2)

theme_set(theme_bw())

p1 <- ggplot(df2 %>% top_frac(0.2, amount_awarded),
             aes(x = reorder(funding_org_name, -amount_awarded),
                 y = amount_awarded, fill = amount_awarded)) + 
  geom_col() + 
  scale_y_sqrt(labels = scales::dollar_format(prefix = "£"),
               breaks = c(1e8, 1e9, 25e8, 4e9, 5e9, 75e8, 1e10)) + 
  scale_x_discrete(labels = scales::wrap_format(25)) + 
  scale_fill_viridis_c() + 
  labs(x = "Funder", y = "Amount Awarded",
       title = "Total Value of Grants Awarded",
       caption = "(c) Evan Odell | 2019 | CC-BY-SA
       Data from 360Giving") + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        legend.position = "none") 
  
p1
```


![](total-value.png)

The plot below shows the average grant value from each funder, with the number of reported grants given by each funder.

```{r avg-grant-size, eval=FALSE}

p2 <- ggplot(df2 %>% top_frac(0.2, avg),
             aes(x = reorder(funding_org_name, -avg),
                 y = avg, fill = avg)) + 
  geom_col() + 
   geom_label(aes(label = scales::comma(n), y = 10000),
              fill = "white", alpha = 0.5, size = 3.5) + 
  scale_y_sqrt(labels = scales::dollar_format(prefix = "£")) + 
  scale_x_discrete(labels = scales::wrap_format(25)) + 
  scale_fill_viridis_c() + 
  labs(x = "Funder", y = "Average Grant Value",
       title = "Average Grant Value",
       subtitle = "Label is the number of grants awarded",
       caption = "(c) Evan Odell | 2019 | CC-BY-SA
       Data from 360Giving") + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        legend.position = "none") 

p2
```

![](avg-grant-value.png)

```{r size, eval=FALSE}
library(ggrepel)

p3 <- ggplot(df2, aes(x = n, y = avg, colour = amount_awarded)) + 
  geom_point(alpha = 0.7, size = 4) + 
  geom_text_repel(data = bind_rows(df2 %>% top_n(5, avg),
                                   df2 %>% top_n(5, amount_awarded),
                                   df2 %>% top_n(5, n)) %>% 
                    distinct(),
                  mapping = aes(label =funding_org_name), colour = "black",
                  direction = "both",
                  nudge_x = 0.2) + 
  scale_colour_viridis_c() + 
  scale_y_log10(labels = scales::dollar_format(prefix = "£")) + 
  scale_x_log10(labels = scales::comma) + 
  labs(y = "Average Grant Value", x = "Number of Grants",
       title = "Average Grant Value vs Number of Grants",
       caption = "(c) Evan Odell | 2019 | CC-BY-SA
       Data from 360Giving") + 
  theme(legend.position = "none") 

p3
```

![](grant-size-n.png)


### Award sizes

In the two examples below, we can see differences between the amount of money applied for and the amount awarded. Not every funder reports the amount applied for, and some report what seem like placeholder values, such as grant programmes where applicants do not need to specify the value of the grant, only what they want to do and leave the award amount up to the funder. 

```{r award-differences, eval=FALSE}
proc_df <- tsg_process_data(grants) 

library(ggrepel)

proc_amount_df <- proc_df  %>% 
  select(identifier, title, description, funding_org_name,
         amount_awarded, amount_applied_for) %>%
  mutate_at(.vars = vars(amount_awarded, amount_applied_for), as.numeric) %>% 
  mutate(difference = amount_awarded-amount_applied_for,
         percentage_of = amount_awarded/amount_applied_for) %>% 
  filter(!is.na(amount_applied_for), amount_applied_for > 2500,
         amount_awarded > 2500,
         percent_rank(difference) >= 0.02 &
           percent_rank(difference) <= 0.98) %>% ## remove outliers
  mutate(difference = round(difference))

count0 <- proc_amount_df %>%
  filter(difference==0) %>%
  tally()
  
p4 <- ggplot(proc_amount_df %>% filter(difference != 0),
             aes(x = difference)) + 
  geom_freqpoly(bins = 100) + 
  geom_label_repel(
    aes(x = 0, y = 4000,
        label = paste0(scales::comma(n),
                       " applications awarded exact amount applied for")),
    data = count0) + 
  scale_color_viridis_c() + 
  scale_y_continuous(labels = scales::comma) + 
  scale_x_continuous(labels = scales::dollar_format(prefix = "£"),
                     breaks = c(-20000, -10000, -5000, -2500,
                                0, 2500, 5000, 7500)) + 
  labs(x = "Difference between Award and Application Amount",
       y = "Number of Grants")

p4

```


```{r percentage awarded, eval=FALSE}
p5 <- ggplot(proc_amount_df %>%
               filter(difference != 0, percentage_of != Inf),
             aes(x = percentage_of)) + 
  geom_freqpoly(bins = 200) + 
  geom_label_repel(
    aes(x = 1, y = 3000, hjust = 1,
        label = paste0(scales::comma(n),
                       " applications awarded amount applied for")),
    data = count0) + 
  scale_color_viridis_c() + 
  scale_y_continuous(labels = scales::comma) + 
  scale_x_continuous(labels = scales::percent,
                     breaks = c(0, 0.25, 0.5, 0.75,0.9, 1, 1.25, 1.5, 2)) + 
  labs(x = "Award size as percentage of amount applied for",
       y = "Number of Grants")

p5
```


Organisations that are focused on systemic change and policy-influencing seem to be particularly reliant on trusts and foundations for income, as their work is harder to sell to ordinary members of the public motivated by emotional connections with an issue, and see their money going to directly help an identifiable person.


```{r}
proc_df <- tsg_process_data(grants)

library(stringr)

strat_df <- proc_df %>%
  filter_at(.vars = vars(description, title, contains("primary"),
                         contains("impact"), contains("category"),
                         contains("classificat")),
            .vars_predicate = any_vars(
              str_detect(., regex('strategy|strategic|systemic', 
                                  ignore_case=TRUE))
              )) %>%
  filter(amount_awarded >= 2500) 

strat_df


proc_df <- proc_df %>%
  mutate(
    strategic = str_detect(description, regex('strategy|strategic|systemic', 
                                  ignore_case=TRUE)
              )
  )




proc_df2 <- proc_df %>% 
  group_by(funding_org_name, strategic) %>% 
  summarise(total = sum(amount_awarded),
            mean = mean(amount_awarded),
            median= median(amount_awarded),
            n= n())

p6 <- ggplot(proc_df2 %>% group_by(strategic) %>% top_n(2, n),
             aes(x = funding_org_name, y = mean, fill = strategic)) + 
  geom_col(position = "dodge")

p6

strat_df <- proc_df %>% filter(strategic)

strat_funders <- strat_df %>%
  group_by(funding_org_name)  %>% 
  summarise(strategic_funding = sum(amount_awarded),
            mean_strategic = mean(amount_awarded),
            median_strategic = median(amount_awarded),
            n_strategic = n()) %>% full_join( proc_df %>% 
  filter(amount_awarded >= 2500) %>%
  group_by(funding_org_name) %>% 
  summarise(total_funding = sum(amount_awarded),
            mean_total = mean(amount_awarded),
            median_total= median(amount_awarded),
            n_total = n())) %>% 
  mutate(percent_strategic = n_strategic/n_total)

library(tidyr)

strat_funders2 <- strat_funders %>%
  pivot_longer(cols = c(mean_strategic, mean_total)) %>%



p7 <- ggplot(data = bind_rows(
  strat_funders %>% top_n(10, n_strategic),
  strat_funders %>% top_n(10, mean_strategic),
  strat_funders %>% top_n(10, strategic_funding)) %>%
    distinct(), aes(x = funding_org_name, colour = strategic)) + 
  geom_col()
  scale_color_viridis_d() + 
  scale_y_log10() + 
  scale_x_continuous() + 
  labs(x = "Award size as percentage of amount applied for",
       y = "Number of Grants")

p7

```



